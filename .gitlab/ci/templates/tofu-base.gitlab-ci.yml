# OpenTofu Base Template
#
# Shared configuration for all OpenTofu CI jobs.
# Provides retry handling, environment setup, and common variables.
#
# Usage:
#   extends: .tofu_base
#
# Features:
#   - Retry on runner system failures
#   - Full git clone (GIT_DEPTH: 0) for state consistency
#   - Common automation settings
#   - GitLab Managed Terraform State support

.tofu_base:
  image:
    name: ghcr.io/opentofu/opentofu:latest
    entrypoint: [""]
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure
      - job_execution_timeout
  variables:
    # Full clone to avoid shallow file race conditions
    GIT_DEPTH: 0
    GIT_STRATEGY: fetch
    # OpenTofu automation settings
    TF_IN_AUTOMATION: "true"
    TF_INPUT: "false"
    # Suppress upgrade notices
    CHECKPOINT_DISABLE: "1"
    # Common paths
    HOME: "/tmp"
    USER: "gitlab-ci"

# OpenTofu base with GitLab HTTP backend
.tofu_gitlab_backend:
  extends: .tofu_base
  variables:
    # GitLab Managed Terraform State
    TF_HTTP_ADDRESS: "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/terraform/state/${TF_STATE_NAME}"
    TF_HTTP_LOCK_ADDRESS: "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/terraform/state/${TF_STATE_NAME}/lock"
    TF_HTTP_UNLOCK_ADDRESS: "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/terraform/state/${TF_STATE_NAME}/lock"
    TF_HTTP_LOCK_METHOD: "POST"
    TF_HTTP_UNLOCK_METHOD: "DELETE"
    TF_HTTP_USERNAME: "gitlab-ci-token"
    TF_HTTP_PASSWORD: "${CI_JOB_TOKEN}"
    TF_HTTP_RETRY_WAIT_MIN: "5"

# OpenTofu with K8s tools installed and GitLab Kubernetes Agent configured
.tofu_with_k8s_tools:
  extends: .tofu_gitlab_backend
  before_script:
    - |
      echo "=== Setting up Kubernetes tools ==="
      apk add --no-cache curl bash jq yq

      # Architecture detection
      ARCH=$(uname -m)
      case $ARCH in
        x86_64)  KUBE_ARCH="amd64" ;;
        aarch64) KUBE_ARCH="arm64" ;;
        arm64)   KUBE_ARCH="arm64" ;;
        *)       KUBE_ARCH="amd64" ;;
      esac
      echo "Architecture: ${ARCH} -> kubectl: ${KUBE_ARCH}"

      # Install kubectl with timeouts to avoid hanging on network issues
      K8S_VERSION=$(curl -L -s --fail --connect-timeout 10 --max-time 30 https://dl.k8s.io/release/stable.txt 2>/dev/null | tr -d '\n' | tr -d ' ')
      [ -z "$K8S_VERSION" ] && K8S_VERSION="v1.31.0"
      echo "kubectl version: ${K8S_VERSION}"

      # Download kubectl binary with timeout (60s connect, 120s max)
      if ! curl -Lo /usr/local/bin/kubectl --fail --connect-timeout 60 --max-time 120 "https://dl.k8s.io/release/${K8S_VERSION}/bin/linux/${KUBE_ARCH}/kubectl"; then
        echo "WARNING: Failed to download kubectl, trying fallback version..."
        curl -Lo /usr/local/bin/kubectl --fail --connect-timeout 60 --max-time 120 "https://dl.k8s.io/release/v1.31.0/bin/linux/${KUBE_ARCH}/kubectl" || {
          echo "ERROR: Could not download kubectl"
          exit 1
        }
      fi
      chmod +x /usr/local/bin/kubectl

      echo "Kubernetes tools installed"

      # Configure GitLab Kubernetes Agent
      # GitLab CI automatically provides kubeconfig via KUBECONFIG env var
      # when using the Kubernetes Agent integration
      echo ""
      echo "=== Configuring GitLab Kubernetes Agent ==="
      if [ -n "${KUBE_CONTEXT:-}" ]; then
        echo "Agent context: ${KUBE_CONTEXT}"

        # Switch to the agent context
        kubectl config use-context "${KUBE_CONTEXT}" || {
          echo "WARNING: Could not switch to context ${KUBE_CONTEXT}"
          echo "Available contexts:"
          kubectl config get-contexts || echo "No contexts available"
        }

        # Verify cluster connection (non-blocking)
        echo ""
        echo "Verifying cluster connection..."
        kubectl cluster-info 2>/dev/null || echo "Note: Cluster info unavailable (may work during apply)"

        # Create kubectl wrapper for GitLab Agent compatibility (v1.27+ OpenAPI bug)
        # See: https://gitlab.com/gitlab-org/gitlab/-/issues/407161
        echo ""
        echo "Installing kubectl wrapper for GitLab Agent compatibility..."
        mkdir -p /tmp/kubectl-wrapper
        cat > /tmp/kubectl-wrapper/kubectl << 'WRAPPER_EOF'
      #!/bin/sh
      # Wrapper to add --validate=false for GitLab Agent compatibility
      REAL_KUBECTL=$(which -a kubectl | grep -v '/tmp/kubectl-wrapper' | head -1)
      case "$1" in
        apply|create|replace|patch)
          cmd="$1"
          shift
          exec $REAL_KUBECTL "$cmd" "$@" --validate=false
          ;;
        *)
          exec $REAL_KUBECTL "$@"
          ;;
      esac
      WRAPPER_EOF
        chmod +x /tmp/kubectl-wrapper/kubectl
        export PATH="/tmp/kubectl-wrapper:$PATH"
        echo "kubectl wrapper installed (adds --validate=false to apply/create/replace/patch)"
      else
        echo "WARNING: KUBE_CONTEXT not set - kubectl commands may fail"
      fi

      echo ""
      echo "=== Setup complete ==="
