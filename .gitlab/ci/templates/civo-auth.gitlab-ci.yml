# Civo Kubernetes Authentication Template
#
# Provides Civo kubeconfig setup for CI jobs.
# Civo uses client certificate authentication (similar to RKE2/k3s).
#
# Usage:
#   extends: .civo_auth_base
#
# Required CI/CD Variables:
#   CIVO_KUBECONFIG - File-type variable containing kubeconfig
#   CIVO_API_KEY    - Civo API key (for object storage, optional)
#
# Outputs Environment Variables:
#   KUBECONFIG         - Path to kubeconfig file
#   TF_VAR_k8s_host    - Kubernetes API server URL
#   TF_VAR_k8s_client_cert - Decoded client certificate
#   TF_VAR_k8s_client_key  - Decoded client key
#   TF_VAR_k8s_insecure    - Set to "true" for self-signed certs

.civo_auth_base:
  variables:
    HOME: "/tmp"
    USER: "gitlab-ci"
    CIVO_CLUSTER_NAME: "bitter-darkness-16657317"
    CIVO_REGION: "NYC1"
  before_script:
    - |
      echo "Installing dependencies..."
      if command -v apk >/dev/null 2>&1; then
        apk add --no-cache curl bash jq yq
      fi

      # Architecture detection
      ARCH=$(uname -m)
      case "$ARCH" in
        x86_64)  KUBECTL_ARCH="amd64" ;;
        aarch64|arm64) KUBECTL_ARCH="arm64" ;;
        *) KUBECTL_ARCH="amd64" ;;
      esac
      echo "   Architecture: $ARCH (kubectl: $KUBECTL_ARCH)"

      # Install kubectl
      echo "Installing kubectl..."
      K8S_VERSION=$(curl -L -s https://dl.k8s.io/release/stable.txt | tr -d '\n' | tr -d ' ')
      [ -z "$K8S_VERSION" ] && K8S_VERSION="v1.31.0"
      curl -LO "https://dl.k8s.io/release/${K8S_VERSION}/bin/linux/${KUBECTL_ARCH}/kubectl"
      chmod +x kubectl && mv kubectl /usr/local/bin/

      echo "Configuring Civo Kubernetes authentication..."
      # Handle CIVO_KUBECONFIG variable (file-type, base64, or raw)
      if [ -n "${CIVO_KUBECONFIG:-}" ]; then
        if [ -f "${CIVO_KUBECONFIG}" ]; then
          export KUBECONFIG="${CIVO_KUBECONFIG}"
          echo "   Using CIVO_KUBECONFIG file: ${CIVO_KUBECONFIG}"
        elif echo "${CIVO_KUBECONFIG}" | base64 -d >/dev/null 2>&1; then
          mkdir -p ~/.kube
          echo "${CIVO_KUBECONFIG}" | base64 -d > ~/.kube/config
          chmod 600 ~/.kube/config
          export KUBECONFIG=~/.kube/config
          echo "   Using base64-decoded CIVO_KUBECONFIG"
        else
          mkdir -p ~/.kube
          echo "${CIVO_KUBECONFIG}" > ~/.kube/config
          chmod 600 ~/.kube/config
          export KUBECONFIG=~/.kube/config
          echo "   Using raw CIVO_KUBECONFIG content"
        fi
      else
        echo "ERROR: CIVO_KUBECONFIG variable not set!"
        echo "   Please set CIVO_KUBECONFIG as a file-type CI/CD variable"
        echo "   Get kubeconfig: civo kubernetes config ${CIVO_CLUSTER_NAME} --save --region ${CIVO_REGION}"
        exit 1
      fi

      # Test connection
      echo "Testing cluster connection..."
      kubectl cluster-info | head -1 || {
        echo "Could not connect to Civo cluster"
        exit 1
      }

      # Extract credentials for OpenTofu kubernetes provider
      HAS_CLIENT_CERT=$(grep -c 'client-certificate-data:' "$KUBECONFIG" 2>/dev/null || echo 0)

      if [ "$HAS_CLIENT_CERT" -gt 0 ]; then
        echo "   Auth type: Client certificate (Civo k3s)"

        export TF_VAR_k8s_host=$(yq -r '.clusters[0].cluster.server' "$KUBECONFIG")
        echo "   K8s Host: $TF_VAR_k8s_host"

        # Decode client certificate
        CLIENT_CERT_B64=$(yq -r '.users[0].user.client-certificate-data' "$KUBECONFIG")
        if [ "$CLIENT_CERT_B64" != "null" ] && [ -n "$CLIENT_CERT_B64" ]; then
          export TF_VAR_k8s_client_cert=$(echo "$CLIENT_CERT_B64" | base64 -d)
          CLIENT_KEY_B64=$(yq -r '.users[0].user.client-key-data' "$KUBECONFIG")
          export TF_VAR_k8s_client_key=$(echo "$CLIENT_KEY_B64" | base64 -d)
          echo "   Client cert extracted successfully"
        else
          echo "ERROR: client-certificate-data not found in kubeconfig"
          exit 1
        fi

        # Civo uses self-signed certificates
        export TF_VAR_k8s_insecure="true"
        export TF_VAR_k8s_token=""
      else
        echo "WARNING: No client certificate found in kubeconfig"
        echo "   This is unexpected for Civo clusters"
        exit 1
      fi

      echo "Civo authentication configured successfully"
      echo "   TF_VAR_k8s_host: ${TF_VAR_k8s_host:-NOT_SET}"
      echo "   TF_VAR_k8s_insecure: ${TF_VAR_k8s_insecure:-false}"
      echo "   KUBECONFIG: ${KUBECONFIG:-NOT_SET}"

# Extended template with Civo CLI
.civo_auth_with_cli:
  extends: .civo_auth_base
  before_script:
    - |
      # Run parent before_script
      echo "Installing Civo CLI..."

      # Detect architecture
      ARCH=$(uname -m)
      case "$ARCH" in
        x86_64)  CIVO_ARCH="amd64" ;;
        aarch64|arm64) CIVO_ARCH="arm64" ;;
        *) CIVO_ARCH="amd64" ;;
      esac

      # Install Civo CLI
      CIVO_VERSION="${CIVO_CLI_VERSION:-1.0.78}"
      curl -sL "https://github.com/civo/cli/releases/download/v${CIVO_VERSION}/civo-${CIVO_VERSION}-linux-${CIVO_ARCH}.tar.gz" \
        | tar -xz -C /usr/local/bin
      chmod +x /usr/local/bin/civo

      # Configure Civo CLI
      if [ -n "${CIVO_API_KEY:-}" ]; then
        civo apikey add default "${CIVO_API_KEY}"
        civo apikey current default
        civo region current "${CIVO_REGION:-NYC1}"
        echo "Civo CLI configured"
      else
        echo "CIVO_API_KEY not set - Civo CLI available but not authenticated"
      fi
