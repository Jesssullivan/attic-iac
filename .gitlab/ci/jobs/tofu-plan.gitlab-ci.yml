# OpenTofu Plan Jobs
#
# Generates execution plans for infrastructure changes.
# - Validate: Runs on all branches and MRs
# - Plan: Generates detailed execution plan with artifacts
# - Plan artifacts are used by apply jobs

# ==============================================================================
# Validation Job
# ==============================================================================

tofu:validate:
  extends: .tofu_with_k8s_tools
  stage: validate
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      when: always
    - if: '$CI_COMMIT_BRANCH == "main"'
      when: always
    - if: '$CI_COMMIT_BRANCH =~ /^(feature|fix|infra)\/.+/'
      when: always
    - if: '$CI_COMMIT_TAG =~ /^v[0-9]+\.[0-9]+\.[0-9]+/'
      when: always
  variables:
    TF_STATE_NAME: "attic-${CI_ENVIRONMENT_SLUG:-production}"
  script:
    - |
      echo "=== OpenTofu Validate ==="
      cd tofu/stacks/attic

      echo "Initializing OpenTofu..."
      tofu init -backend=false

      echo ""
      echo "Validating configuration..."
      tofu validate

      echo ""
      echo "Formatting check..."
      tofu fmt -check -recursive || {
        echo "WARNING: Some files are not formatted. Run 'tofu fmt -recursive' locally."
      }

      echo ""
      echo "Validation complete"

# ==============================================================================
# Plan Jobs
# ==============================================================================

# Base plan template
.tofu_plan_base:
  extends: .tofu_with_k8s_tools
  stage: build
  needs:
    - job: tofu:validate
      artifacts: false
  before_script:
    - !reference [.civo_auth_base, before_script]
  script:
    - |
      echo "=== OpenTofu Plan (${TF_ENVIRONMENT:-default}) ==="
      cd tofu/stacks/attic

      # Configure GitLab state backend
      export TF_HTTP_ADDRESS="${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/terraform/state/${TF_STATE_NAME}"
      export TF_HTTP_LOCK_ADDRESS="${TF_HTTP_ADDRESS}/lock"
      export TF_HTTP_UNLOCK_ADDRESS="${TF_HTTP_ADDRESS}/lock"
      export TF_HTTP_LOCK_METHOD="POST"
      export TF_HTTP_UNLOCK_METHOD="DELETE"
      export TF_HTTP_USERNAME="gitlab-ci-token"
      export TF_HTTP_PASSWORD="${CI_JOB_TOKEN}"

      echo "State: ${TF_HTTP_ADDRESS}"

      echo ""
      echo "Initializing OpenTofu..."
      tofu init

      echo ""
      echo "Generating plan..."

      # Build var flags - database_url is optional when using CNPG
      VAR_FLAGS=(
        -var="civo_api_key=${CIVO_API_KEY}"
        -var="attic_jwt_secret_base64=${ATTIC_JWT_SECRET}"
        -var="namespace=${TF_VAR_namespace:-nix-cache}"
        -var="environment=${TF_VAR_environment:-production}"
        -var="deploy_version=${CI_COMMIT_TAG:-${CI_COMMIT_SHORT_SHA}}"
        -var="use_cnpg_postgres=true"
      )

      # Load environment-specific tfvars if it exists
      if [ -f "${TF_VAR_environment:-production}.tfvars" ]; then
        echo "Loading ${TF_VAR_environment:-production}.tfvars"
        VAR_FLAGS+=(-var-file="${TF_VAR_environment:-production}.tfvars")
      fi

      # Only pass database_url if ATTIC_DATABASE_URL is set and non-empty
      # With use_cnpg_postgres=true, the URL is generated by CloudNativePG
      if [ -n "${ATTIC_DATABASE_URL:-}" ]; then
        VAR_FLAGS+=(-var="database_url=${ATTIC_DATABASE_URL}")
      fi

      # Add DreamHost API key if using dreamhost provider
      if [ -n "${DREAMHOST_API_KEY:-}" ]; then
        VAR_FLAGS+=(-var="dreamhost_api_key=${DREAMHOST_API_KEY}")
        VAR_FLAGS+=(-var="dns_provider=dreamhost")
      fi

      tofu plan "${VAR_FLAGS[@]}" -out=tfplan

      echo ""
      echo "Plan summary:"
      tofu show -no-color tfplan | tee plan-output.txt

      # Generate JSON plan for MR comments
      tofu show -json tfplan > plan.json

  artifacts:
    paths:
      - tofu/stacks/attic/tfplan
      - tofu/stacks/attic/plan-output.txt
      - tofu/stacks/attic/plan.json
      - tofu/stacks/attic/.terraform/
      - tofu/stacks/attic/.terraform.lock.hcl
    reports:
      terraform: tofu/stacks/attic/plan-output.txt
    expire_in: 7 days

# Plan for production (main branch and tags)
tofu:plan:
  extends: .tofu_plan_base
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      when: always
    - if: '$CI_COMMIT_BRANCH == "main"'
      when: always
  variables:
    TF_STATE_NAME: "attic-production"
    TF_ENVIRONMENT: "production"
    TF_VAR_namespace: "nix-cache"
    TF_VAR_environment: "production"
  environment:
    name: production
    action: prepare

# Plan for production tags
tofu:plan:production:
  extends: .tofu_plan_base
  rules:
    - if: '$CI_COMMIT_TAG =~ /^v[0-9]+\.[0-9]+\.[0-9]+/'
      when: always
  variables:
    TF_STATE_NAME: "attic-production"
    TF_ENVIRONMENT: "production"
    TF_VAR_namespace: "nix-cache"
    TF_VAR_environment: "production"
  environment:
    name: production
    action: prepare

# Plan for staging environment
tofu:plan:staging:
  extends: .tofu_plan_base
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      when: always
    - if: '$CI_COMMIT_BRANCH =~ /^(feature|fix|infra)\/.+/'
      when: always
  variables:
    TF_STATE_NAME: "attic-staging"
    TF_ENVIRONMENT: "staging"
    TF_VAR_namespace: "nix-cache-staging"
    TF_VAR_environment: "staging"
  environment:
    name: staging
    action: prepare

# ==============================================================================
# Drift Detection Job
# ==============================================================================
#
# Runs on schedule to detect configuration drift between
# the deployed infrastructure and the IaC code.
# Schedule: Daily at 6am UTC (configure in GitLab CI/CD > Schedules)

tofu:drift-detection:
  extends: .tofu_with_k8s_tools
  stage: verify
  rules:
    # Only run on scheduled pipelines
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: always
  variables:
    TF_STATE_NAME: "attic-production"
  before_script:
    - !reference [.civo_auth_base, before_script]
  script:
    - |
      echo "=== Infrastructure Drift Detection ==="
      cd tofu/stacks/attic

      # Configure GitLab state backend
      export TF_HTTP_ADDRESS="${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/terraform/state/${TF_STATE_NAME}"
      export TF_HTTP_LOCK_ADDRESS="${TF_HTTP_ADDRESS}/lock"
      export TF_HTTP_UNLOCK_ADDRESS="${TF_HTTP_ADDRESS}/lock"
      export TF_HTTP_LOCK_METHOD="POST"
      export TF_HTTP_UNLOCK_METHOD="DELETE"
      export TF_HTTP_USERNAME="gitlab-ci-token"
      export TF_HTTP_PASSWORD="${CI_JOB_TOKEN}"

      echo "Initializing OpenTofu..."
      tofu init

      echo ""
      echo "Checking for drift..."

      # Build var flags
      VAR_FLAGS=(
        -var="civo_api_key=${CIVO_API_KEY}"
        -var="attic_jwt_secret_base64=${ATTIC_JWT_SECRET}"
        -var="namespace=nix-cache"
        -var="environment=production"
        -var="use_cnpg_postgres=true"
      )

      if [ -n "${ATTIC_DATABASE_URL:-}" ]; then
        VAR_FLAGS+=(-var="database_url=${ATTIC_DATABASE_URL}")
      fi

      if [ -n "${DREAMHOST_API_KEY:-}" ]; then
        VAR_FLAGS+=(-var="dreamhost_api_key=${DREAMHOST_API_KEY}")
        VAR_FLAGS+=(-var="dns_provider=dreamhost")
      fi

      # Run plan with detailed exit code
      # Exit code 0 = no changes, 1 = error, 2 = changes detected
      DRIFT_STATUS=0
      tofu plan "${VAR_FLAGS[@]}" -detailed-exitcode -out=drift-plan || DRIFT_STATUS=$?

      if [ $DRIFT_STATUS -eq 0 ]; then
        echo ""
        echo "No drift detected - infrastructure matches configuration"
      elif [ $DRIFT_STATUS -eq 2 ]; then
        echo ""
        echo "DRIFT DETECTED - Infrastructure differs from configuration!"
        echo ""
        echo "Changes that would be applied:"
        tofu show -no-color drift-plan | tee drift-report.txt
        echo ""
        echo "Review the drift report and consider applying changes."
        exit 1
      else
        echo ""
        echo "ERROR: Plan failed with exit code $DRIFT_STATUS"
        exit 1
      fi
  artifacts:
    when: on_failure
    paths:
      - tofu/stacks/attic/drift-report.txt
    expire_in: 7 days
  allow_failure: true

# ==============================================================================
# Security Scanning Job
# ==============================================================================
#
# Uses tfsec to scan OpenTofu code for security issues.

tofu:security-scan:
  stage: validate
  image:
    # Use Trivy instead of deprecated tfsec - better maintained and same functionality
    name: aquasec/trivy:latest
    entrypoint: [""]
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      when: always
    - if: '$CI_COMMIT_BRANCH == "main"'
      when: always
  script:
    - echo "=== OpenTofu Security Scan ==="
    - echo "Scanning with Trivy (tfsec successor)..."
    - trivy config tofu/ --format json --output trivy-report.json || true
    - trivy config tofu/ --format table | tee trivy-output.txt || true
    - echo ""
    - echo "Scan complete. See artifacts for details."
  artifacts:
    paths:
      - trivy-report.json
      - trivy-output.txt
    expire_in: 7 days
  allow_failure: true
