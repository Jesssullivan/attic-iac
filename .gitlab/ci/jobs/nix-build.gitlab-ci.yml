# Nix Build Jobs
# ==============
#
# These jobs build Nix packages and push them to the Attic cache.
# Uses Alpine with Nix installed via DeterminateSystems installer since
# nixos/nix images lack /bin/sh required by GitLab Runner.

.nix-build-base:
  stage: build
  image: alpine:3.21
  tags:
    - nix
  interruptible: true
  timeout: 90 minutes
  before_script:
    - apk add --no-cache curl xz bash git
    # Fix /nix permissions (runner mounts emptyDir which is world-writable)
    - chmod 755 /nix 2>/dev/null || true
    - curl --proto '=https' --tlsv1.2 -sSf -L https://install.determinate.systems/nix | sh -s -- install linux --no-confirm --init none
    - . /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh
    - nix --version
    # Dogfood: use our Attic cache as a substituter (pull cached builds)
    # Adds both stable and review URLs â€” nix silently skips unreachable ones
    - |
      CACHE_NAME="${ATTIC_CACHE:-main}"
      if [ -n "${ATTIC_SERVER:-}" ]; then
        echo "Configuring Attic substituter: ${ATTIC_SERVER}/${CACHE_NAME}"
        echo "extra-substituters = ${ATTIC_SERVER}/${CACHE_NAME}" >> /etc/nix/nix.conf
        echo "trusted-substituters = ${ATTIC_SERVER}/${CACHE_NAME}" >> /etc/nix/nix.conf
      fi
      if [ -n "${CI_COMMIT_REF_SLUG:-}" ]; then
        REVIEW_URL="https://${FIXED_SUBDOMAIN:-attic-cache}-${CI_COMMIT_REF_SLUG}.${KUBE_INGRESS_BASE_DOMAIN:-beehive.bates.edu}/${CACHE_NAME}"
        echo "Also trying review cache: ${REVIEW_URL}"
        echo "extra-substituters = ${REVIEW_URL}" >> /etc/nix/nix.conf
        echo "trusted-substituters = ${REVIEW_URL}" >> /etc/nix/nix.conf
      fi
  artifacts:
    paths:
      - result*
    expire_in: 1 day

# Build Attic client
# NOTE: allow_failure until Attic cache is deployed - builds take 60+ min uncached
nix:build-client:
  extends: .nix-build-base
  needs: [] # Run immediately - don't wait for validate stage
  allow_failure: true
  script:
    - echo "Building Attic client..."
    - nix build .#attic-client --print-build-logs --out-link result-client
    - |
      # Push to Attic cache (auth-free, best-effort)
      # Try review URL first (MR pipelines), fall back to stable URL
      PUSH_SERVER=""
      if [ -n "${CI_COMMIT_REF_SLUG:-}" ]; then
        REVIEW_SERVER="https://${FIXED_SUBDOMAIN:-attic-cache}-${CI_COMMIT_REF_SLUG}.${KUBE_INGRESS_BASE_DOMAIN:-beehive.bates.edu}"
        if curl -sSf "${REVIEW_SERVER}/" --connect-timeout 5 --max-time 10 >/dev/null 2>&1; then
          PUSH_SERVER="${REVIEW_SERVER}"
        fi
      fi
      if [ -z "$PUSH_SERVER" ] && [ -n "${ATTIC_SERVER:-}" ]; then
        if curl -sSf "${ATTIC_SERVER}/" --connect-timeout 5 --max-time 10 >/dev/null 2>&1; then
          PUSH_SERVER="${ATTIC_SERVER}"
        fi
      fi
      if [ -n "$PUSH_SERVER" ]; then
        echo "Pushing to Attic: ${PUSH_SERVER}"
        nix run .#attic -- login --set-default ci "$PUSH_SERVER" || true
        nix run .#attic -- push "${ATTIC_CACHE:-main}" result-client || echo "WARNING: Cache push failed (non-blocking)"
      else
        echo "SKIP: No reachable Attic server"
      fi
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

# Build Attic server container image
# NOTE: allow_failure until Attic cache is deployed - builds take 60+ min uncached
nix:build-container:
  extends: .nix-build-base
  needs: [] # Run immediately - don't wait for validate stage
  allow_failure: true
  script:
    - echo "Building Attic server container..."
    - nix build .#container --print-build-logs --out-link result-container
    - |
      # Build the copyTo script for pushing to registries
      # nix2container uses a special nix: transport that skopeo needs
      echo "Building container push script..."
      nix build '.#container.copyTo' --out-link result-copy-to
    - |
      # Show image info
      if [ -e result-container ]; then
        echo "Container image manifest built successfully"
        cat result-container | head -20
      fi
    - |
      # Push to Attic cache (auth-free, best-effort)
      PUSH_SERVER=""
      if [ -n "${CI_COMMIT_REF_SLUG:-}" ]; then
        REVIEW_SERVER="https://${FIXED_SUBDOMAIN:-attic-cache}-${CI_COMMIT_REF_SLUG}.${KUBE_INGRESS_BASE_DOMAIN:-beehive.bates.edu}"
        if curl -sSf "${REVIEW_SERVER}/" --connect-timeout 5 --max-time 10 >/dev/null 2>&1; then
          PUSH_SERVER="${REVIEW_SERVER}"
        fi
      fi
      if [ -z "$PUSH_SERVER" ] && [ -n "${ATTIC_SERVER:-}" ]; then
        if curl -sSf "${ATTIC_SERVER}/" --connect-timeout 5 --max-time 10 >/dev/null 2>&1; then
          PUSH_SERVER="${ATTIC_SERVER}"
        fi
      fi
      if [ -n "$PUSH_SERVER" ]; then
        echo "Pushing to Attic: ${PUSH_SERVER}"
        nix run .#attic -- login --set-default ci "$PUSH_SERVER" || true
        nix run .#attic -- push "${ATTIC_CACHE:-main}" result-container || echo "WARNING: Cache push failed (non-blocking)"
      else
        echo "SKIP: No reachable Attic server"
      fi
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

# Build GC image
# NOTE: allow_failure until Attic cache is deployed - builds take 60+ min uncached
nix:build-gc-image:
  extends: .nix-build-base
  needs: [] # Run immediately - don't wait for validate stage
  allow_failure: true
  script:
    - echo "Building Attic GC container..."
    - nix build .#attic-gc-image --print-build-logs --out-link result-gc
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# Push container to registry
# Note: We rebuild the copy-to script here because GitLab artifacts are symlinks
# to nix store paths that don't exist in the push job's environment.
# The rebuild is fast when using Attic cache.
# NOTE: allow_failure until Attic cache is deployed - builds take 60+ min uncached
nix:push-container:
  extends: .nix-build-base
  stage: deploy
  allow_failure: true
  needs:
    - job: nix:build-container
      optional: true
  script:
    - echo "Pushing container to registry..."
    - |
      if [ -n "${CI_REGISTRY:-}" ] && [ -n "${CI_REGISTRY_USER:-}" ]; then
        # Build the copyTo script (fast if cached in Attic)
        # Artifacts are symlinks to nix store paths that don't exist here
        echo "Building container copy-to script..."
        nix build '.#container.copyTo' --out-link result-copy-to

        COPY_TO="./result-copy-to/bin/copy-to"

        if [ ! -x "$COPY_TO" ]; then
          echo "ERROR: copyTo script build failed"
          exit 1
        fi

        # Use --dest-creds to authenticate to GitLab registry
        DEST_CREDS="--dest-creds=${CI_REGISTRY_USER}:${CI_REGISTRY_PASSWORD}"

        echo "Pushing image: ${CI_REGISTRY_IMAGE}/attic-server:${CI_COMMIT_SHORT_SHA}"
        "$COPY_TO" "docker://${CI_REGISTRY_IMAGE}/attic-server:${CI_COMMIT_SHORT_SHA}" "$DEST_CREDS"

        echo "Pushing image: ${CI_REGISTRY_IMAGE}/attic-server:latest"
        "$COPY_TO" "docker://${CI_REGISTRY_IMAGE}/attic-server:latest" "$DEST_CREDS"

        echo "Successfully pushed container images"
      else
        echo "SKIP: Container registry not configured"
      fi
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  environment:
    name: production
    url: https://attic-cache.rigel.bates.edu

# Full build with all outputs
nix:build-all:
  extends: .nix-build-base
  script:
    - echo "Building all flake outputs..."
    - nix build .#attic-client --out-link result-client
    - nix build .#attic-server --out-link result-server
    - nix build .#container --out-link result-container
    - nix build .#attic-gc-image --out-link result-gc
    - |
      echo "Build summary:"
      ls -la result-*
    - |
      # Push to Attic cache (auth-free, best-effort)
      PUSH_SERVER=""
      if [ -n "${CI_COMMIT_REF_SLUG:-}" ]; then
        REVIEW_SERVER="https://${FIXED_SUBDOMAIN:-attic-cache}-${CI_COMMIT_REF_SLUG}.${KUBE_INGRESS_BASE_DOMAIN:-beehive.bates.edu}"
        if curl -sSf "${REVIEW_SERVER}/" --connect-timeout 5 --max-time 10 >/dev/null 2>&1; then
          PUSH_SERVER="${REVIEW_SERVER}"
        fi
      fi
      if [ -z "$PUSH_SERVER" ] && [ -n "${ATTIC_SERVER:-}" ]; then
        if curl -sSf "${ATTIC_SERVER}/" --connect-timeout 5 --max-time 10 >/dev/null 2>&1; then
          PUSH_SERVER="${ATTIC_SERVER}"
        fi
      fi
      if [ -n "$PUSH_SERVER" ]; then
        echo "Pushing to Attic: ${PUSH_SERVER}"
        nix run .#attic -- login --set-default ci "$PUSH_SERVER" || true
        nix run .#attic -- push "${ATTIC_CACHE:-main}" result-* || echo "WARNING: Cache push failed (non-blocking)"
      else
        echo "SKIP: No reachable Attic server"
      fi
  rules:
    - if: $CI_COMMIT_TAG
    - if: $CI_PIPELINE_SOURCE == "schedule"
