#!/usr/bin/env bash
# Pre-commit hook for attic-cache repository
# Install: git config core.hooksPath .githooks
#
# This hook enforces:
# 1. No secrets/credentials in commits
# 2. No Co-Authored-By lines
# 3. No .claude or CLAUDE files
# 4. Auto-formatting where possible

set -euo pipefail

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${GREEN}Running pre-commit checks...${NC}"

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$STAGED_FILES" ]; then
    echo "No staged files to check"
    exit 0
fi

ERRORS=0

# =============================================================================
# 1. SECRET DETECTION
# =============================================================================
echo -e "${YELLOW}Checking for secrets...${NC}"

# Patterns that indicate secrets
SECRET_PATTERNS=(
    # API keys and tokens
    'glpat-[a-zA-Z0-9_-]{20}'           # GitLab Personal Access Token
    'ghp_[a-zA-Z0-9]{36}'               # GitHub Personal Access Token
    'AKIA[0-9A-Z]{16}'                  # AWS Access Key ID
    'sk-[a-zA-Z0-9]{48}'                # OpenAI API Key
    'xox[baprs]-[0-9a-zA-Z-]+'          # Slack tokens

    # Generic patterns
    'password\s*[:=]\s*["\047][^"\047]{8,}["\047]'
    'secret\s*[:=]\s*["\047][^"\047]{8,}["\047]'
    'api[_-]?key\s*[:=]\s*["\047][^"\047]{8,}["\047]'
    'token\s*[:=]\s*["\047][^"\047]{8,}["\047]'

    # Private keys
    '-----BEGIN (RSA |DSA |EC |OPENSSH )?PRIVATE KEY-----'
    '-----BEGIN PGP PRIVATE KEY BLOCK-----'

    # Kubernetes/kubeconfig tokens
    'kubeconfig-[a-z0-9-]+:[a-z0-9]+'
)

# File patterns that should never be committed
FORBIDDEN_FILES=(
    '\.tfplan$'
    '\.tfstate$'
    'kubeconfig'
    '\.env$'
    '\.env\.local$'
    'id_rsa$'
    'id_ed25519$'
    '\.pem$'
    '\.key$'
    'credentials\.json$'
)

# Check staged files for secrets
for file in $STAGED_FILES; do
    # Skip binary files
    if file "$file" 2>/dev/null | grep -q "binary"; then
        continue
    fi

    # Check file name patterns
    for pattern in "${FORBIDDEN_FILES[@]}"; do
        if echo "$file" | grep -qE "$pattern"; then
            echo -e "${RED}ERROR: Forbidden file type staged: $file${NC}"
            echo "  Pattern matched: $pattern"
            ERRORS=$((ERRORS + 1))
        fi
    done

    # Check file contents for secrets
    if [ -f "$file" ]; then
        for pattern in "${SECRET_PATTERNS[@]}"; do
            if git diff --cached "$file" | grep -qE "$pattern" 2>/dev/null; then
                echo -e "${RED}ERROR: Potential secret detected in $file${NC}"
                echo "  Pattern: $pattern"
                ERRORS=$((ERRORS + 1))
            fi
        done
    fi
done

# =============================================================================
# 2. NO CO-AUTHORED-BY CHECK
# =============================================================================
echo -e "${YELLOW}Checking for Co-Authored-By...${NC}"

# Check if any staged files contain Co-Authored-By
# Note: Skip .githooks/ directory (contains detection patterns)
for file in $STAGED_FILES; do
    # Skip hook scripts themselves
    if echo "$file" | grep -q "^\.githooks/"; then
        continue
    fi
    if [ -f "$file" ] && grep -qi "co-authored-by" "$file" 2>/dev/null; then
        echo -e "${RED}ERROR: Co-Authored-By found in $file${NC}"
        echo "  Remove Co-Authored-By lines before committing"
        ERRORS=$((ERRORS + 1))
    fi
done

# =============================================================================
# 3. NO .CLAUDE OR CLAUDE FILES
# =============================================================================
echo -e "${YELLOW}Checking for CLAUDE files...${NC}"

for file in $STAGED_FILES; do
    if echo "$file" | grep -qiE '(^|/)\.?claude|CLAUDE\.(md|txt|json)$'; then
        echo -e "${RED}ERROR: CLAUDE-related file staged: $file${NC}"
        echo "  These files should not be committed to the repository"
        ERRORS=$((ERRORS + 1))
    fi
done

# =============================================================================
# 4. AUTO-FORMATTING (with auto-fix)
# =============================================================================
echo -e "${YELLOW}Running formatters...${NC}"

# Check if nix is available for formatting
if command -v nix &> /dev/null; then
    # Get Nix files that were staged
    NIX_FILES=$(echo "$STAGED_FILES" | grep -E '\.nix$' || true)

    if [ -n "$NIX_FILES" ]; then
        echo "Formatting Nix files..."
        nix fmt . 2>/dev/null || true

        # Re-add any formatted files
        for file in $NIX_FILES; do
            if [ -f "$file" ]; then
                git add "$file"
            fi
        done
    fi
fi

# Check if tofu/terraform is available for HCL formatting
if command -v tofu &> /dev/null; then
    TF_FILES=$(echo "$STAGED_FILES" | grep -E '\.(tf|tfvars)$' || true)

    if [ -n "$TF_FILES" ]; then
        echo "Formatting Terraform/OpenTofu files..."
        for file in $TF_FILES; do
            if [ -f "$file" ]; then
                tofu fmt "$file" 2>/dev/null || true
                git add "$file"
            fi
        done
    fi
fi

# Check if prettier is available for other files
if command -v prettier &> /dev/null || command -v npx &> /dev/null; then
    OTHER_FILES=$(echo "$STAGED_FILES" | grep -E '\.(json|yaml|yml|md)$' || true)

    if [ -n "$OTHER_FILES" ]; then
        echo "Formatting JSON/YAML/Markdown files..."
        for file in $OTHER_FILES; do
            if [ -f "$file" ]; then
                if command -v prettier &> /dev/null; then
                    prettier --write "$file" 2>/dev/null || true
                fi
                git add "$file"
            fi
        done
    fi
fi

# =============================================================================
# FINAL RESULT
# =============================================================================
if [ $ERRORS -gt 0 ]; then
    echo ""
    echo -e "${RED}Pre-commit checks failed with $ERRORS error(s)${NC}"
    echo "Please fix the issues above and try again."
    exit 1
fi

echo -e "${GREEN}All pre-commit checks passed!${NC}"
exit 0
