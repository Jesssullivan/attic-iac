---
# Attic Secrets Template
#
# This is a TEMPLATE file showing the structure of secrets used by Attic.
# DO NOT store actual secret values in this file.
#
# Production secrets are managed via:
# 1. OpenTofu (tofu/stacks/attic/main.tf) - Primary method
# 2. Sealed Secrets - For GitOps workflows
# 3. External Secrets Operator - For Vault integration
#
# To create secrets manually (development only):
#   kubectl create secret generic attic-secrets \
#     --from-literal=ATTIC_SERVER_TOKEN_RS256_SECRET_BASE64="<base64-encoded-rsa-key>" \
#     --from-literal=DATABASE_URL="postgresql://..." \
#     --from-literal=AWS_ACCESS_KEY_ID="<access-key>" \
#     --from-literal=AWS_SECRET_ACCESS_KEY="<secret-key>" \
#     -n nix-cache

# =============================================================================
# Core Attic Secrets
# =============================================================================
apiVersion: v1
kind: Secret
metadata:
  name: attic-secrets
  namespace: nix-cache
  labels:
    app.kubernetes.io/name: attic
    app.kubernetes.io/component: secrets
    app.kubernetes.io/managed-by: opentofu
    app.kubernetes.io/part-of: nix-cache
  annotations:
    description: "Core secrets for Attic server operation"
type: Opaque
stringData:
  # JWT signing key (RS256 private key, base64 encoded)
  # Generate with: openssl genrsa 4096 | base64 -w0
  ATTIC_SERVER_TOKEN_RS256_SECRET_BASE64: "<base64-encoded-rsa-private-key>"

  # PostgreSQL connection URL
  # Format: postgresql://user:password@host:port/database?sslmode=require
  DATABASE_URL: "<postgresql-connection-string>"

  # S3 credentials for NAR storage
  AWS_ACCESS_KEY_ID: "<s3-access-key>"
  AWS_SECRET_ACCESS_KEY: "<s3-secret-key>"

---
# =============================================================================
# CI Tokens Secret
# =============================================================================
apiVersion: v1
kind: Secret
metadata:
  name: attic-ci-tokens
  namespace: nix-cache
  labels:
    app.kubernetes.io/name: attic
    app.kubernetes.io/component: ci-tokens
    app.kubernetes.io/managed-by: opentofu
    attic.dev/token-type: ci
  annotations:
    attic.dev/rotation-date: "<iso8601-timestamp>"
    attic.dev/next-rotation: "<iso8601-timestamp>"
    attic.dev/validity-days: "90"
    attic.dev/managed-by: opentofu
    attic.dev/rotation-enabled: "true"
type: Opaque
stringData:
  # Each entry is a JSON object with token metadata
  # Format: {"token_id": "...", "secret": "...", "permissions": [...], "caches": [...], "expires_at": "...", "sub": "..."}
  gitlab-tinyland-gnucashr: |
    {
      "token_id": "ci-gitlab-tinyland-gnucashr-xxxx",
      "secret": "<token-secret>",
      "permissions": ["push", "pull"],
      "caches": ["main"],
      "expires_at": "<iso8601-timestamp>",
      "sub": "ci:gitlab-tinyland-gnucashr"
    }
  gitlab-tinyland-attic-cache: |
    {
      "token_id": "ci-gitlab-tinyland-attic-cache-xxxx",
      "secret": "<token-secret>",
      "permissions": ["push", "pull"],
      "caches": ["main"],
      "expires_at": "<iso8601-timestamp>",
      "sub": "ci:gitlab-tinyland-attic-cache"
    }
  github-jesssullivan-gnucashr: |
    {
      "token_id": "ci-github-jesssullivan-gnucashr-xxxx",
      "secret": "<token-secret>",
      "permissions": ["push", "pull"],
      "caches": ["main"],
      "expires_at": "<iso8601-timestamp>",
      "sub": "ci:github-jesssullivan-gnucashr"
    }

---
# =============================================================================
# Read-Only Tokens Secret
# =============================================================================
apiVersion: v1
kind: Secret
metadata:
  name: attic-readonly-tokens
  namespace: nix-cache
  labels:
    app.kubernetes.io/name: attic
    app.kubernetes.io/component: readonly-tokens
    app.kubernetes.io/managed-by: opentofu
    attic.dev/token-type: readonly
  annotations:
    attic.dev/rotation-date: "<iso8601-timestamp>"
    attic.dev/next-rotation: "<iso8601-timestamp>"
    attic.dev/validity-days: "90"
    attic.dev/managed-by: opentofu
type: Opaque
stringData:
  public-pull: |
    {
      "token_id": "ro-public-pull-xxxx",
      "secret": "<token-secret>",
      "permissions": ["pull"],
      "caches": ["main"],
      "expires_at": "<iso8601-timestamp>",
      "sub": "readonly:public-pull"
    }

---
# =============================================================================
# Service Tokens Secret
# =============================================================================
apiVersion: v1
kind: Secret
metadata:
  name: attic-service-tokens
  namespace: nix-cache
  labels:
    app.kubernetes.io/name: attic
    app.kubernetes.io/component: service-tokens
    app.kubernetes.io/managed-by: opentofu
    attic.dev/token-type: service
  annotations:
    attic.dev/rotation-date: "<iso8601-timestamp>"
    attic.dev/next-rotation: "<iso8601-timestamp>"
    attic.dev/validity-days: "365"
    attic.dev/managed-by: opentofu
type: Opaque
stringData:
  gc-worker: |
    {
      "token_id": "svc-gc-worker-xxxx",
      "secret": "<token-secret>",
      "permissions": ["admin"],
      "caches": ["main"],
      "expires_at": "<iso8601-timestamp>",
      "sub": "service:gc-worker"
    }

---
# =============================================================================
# Root Token Secret (Highly Sensitive)
# =============================================================================
apiVersion: v1
kind: Secret
metadata:
  name: attic-root-token
  namespace: nix-cache
  labels:
    app.kubernetes.io/name: attic
    app.kubernetes.io/component: root-token
    app.kubernetes.io/managed-by: opentofu
    attic.dev/token-type: root
  annotations:
    attic.dev/rotation-date: "<iso8601-timestamp>"
    attic.dev/next-rotation: "<iso8601-timestamp>"
    attic.dev/validity-days: "180"
    attic.dev/managed-by: opentofu
    attic.dev/high-privilege: "true"
    attic.dev/audit-required: "true"
type: Opaque
stringData:
  root: |
    {
      "token_id": "root-xxxx",
      "secret": "<token-secret>",
      "permissions": ["*"],
      "caches": ["*"],
      "expires_at": "<iso8601-timestamp>",
      "sub": "root",
      "admin": true
    }

---
# =============================================================================
# Token Revocation List ConfigMap
# =============================================================================
apiVersion: v1
kind: ConfigMap
metadata:
  name: attic-token-revocation-list
  namespace: nix-cache
  labels:
    app.kubernetes.io/name: attic
    app.kubernetes.io/component: revocation-list
    app.kubernetes.io/managed-by: opentofu
  annotations:
    attic.dev/last-updated: "<iso8601-timestamp>"
data:
  revoked_tokens.json: |
    {
      "revoked": [],
      "updated": "<iso8601-timestamp>",
      "revision": 1
    }

---
# =============================================================================
# Token Audit ConfigMap
# =============================================================================
apiVersion: v1
kind: ConfigMap
metadata:
  name: attic-token-audit
  namespace: nix-cache
  labels:
    app.kubernetes.io/name: attic
    app.kubernetes.io/component: audit
    app.kubernetes.io/managed-by: opentofu
data:
  token_inventory.json: |
    {
      "ci_tokens": {
        "gitlab-tinyland-gnucashr": {
          "token_id": "ci-gitlab-tinyland-gnucashr-xxxx",
          "caches": ["main"],
          "permissions": ["push", "pull"],
          "expires_at": "<iso8601-timestamp>"
        }
      },
      "readonly_tokens": {
        "public-pull": {
          "token_id": "ro-public-pull-xxxx",
          "caches": ["main"],
          "permissions": ["pull"],
          "expires_at": "<iso8601-timestamp>"
        }
      },
      "service_tokens": {
        "gc-worker": {
          "token_id": "svc-gc-worker-xxxx",
          "caches": ["main"],
          "permissions": ["admin"],
          "expires_at": "<iso8601-timestamp>"
        }
      },
      "root_token_exists": true,
      "generated_at": "<iso8601-timestamp>",
      "environment": "production"
    }

---
# =============================================================================
# RBAC for Token Access
# =============================================================================
apiVersion: v1
kind: ServiceAccount
metadata:
  name: attic-token-accessor
  namespace: nix-cache
  labels:
    app.kubernetes.io/name: attic
    app.kubernetes.io/component: tokens
    app.kubernetes.io/managed-by: opentofu
  annotations:
    attic.dev/purpose: "Provides controlled access to token secrets"

---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: attic-token-reader
  namespace: nix-cache
  labels:
    app.kubernetes.io/name: attic
    app.kubernetes.io/component: tokens
    app.kubernetes.io/managed-by: opentofu
rules:
  - apiGroups: [""]
    resources: ["secrets"]
    resourceNames:
      - attic-ci-tokens
      - attic-readonly-tokens
    verbs: ["get"]
  - apiGroups: [""]
    resources: ["configmaps"]
    resourceNames:
      - attic-token-revocation-list
    verbs: ["get", "list", "watch"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: attic-token-reader
  namespace: nix-cache
  labels:
    app.kubernetes.io/name: attic
    app.kubernetes.io/component: tokens
    app.kubernetes.io/managed-by: opentofu
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: attic-token-reader
subjects:
  - kind: ServiceAccount
    name: attic-token-accessor
    namespace: nix-cache
